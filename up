#!/bin/bash

set -xeuo pipefail

cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"

readonly NVIM="$HOME/bin/nvim.appimage"
curl -sSLfo "$NVIM" 'https://github.com/neovim/neovim/releases/download/nightly/nvim.appimage'
chmod a+x "$NVIM"
for alt in ex vi view vim vimdiff nvim; do
  ln -sf "$NVIM" "$HOME/bin/$alt"
done

curl -sSLf \
    'https://github.com/dandavison/delta/releases/download/0.15.1/delta-0.15.1-x86_64-unknown-linux-musl.tar.gz' \
  | tar -C "$HOME"/bin -z --get --strip-components=1 delta-0.15.1-x86_64-unknown-linux-musl/delta

clean_clangd() {
  for f in "$HOME/.local/clangd*"; do
    if [ -e "$f" ]; then
      rm -rf -- "$f"
    fi
  done
}

clean_clangd
curl -sSLfo "$HOME/.local/clangd.zip" \
    'https://github.com/clangd/clangd/releases/download/15.0.6/clangd-linux-15.0.6.zip'
unzip -qqod "$HOME/.local" "$HOME/.local/clangd.zip"
rsync -a "$HOME/.local/clangd_"*/ "$HOME/.local"
clean_clangd

rm -rf "$HOME/.local/arcanist{-master,.zip}"
curl -sSLfo "$HOME/.local/arcanist.zip" \
  'https://github.com/phacility/arcanist/archive/refs/heads/master.zip'
unzip -qqod "$HOME/.local" "$HOME/.local/arcanist.zip"
ln -sf "$HOME/.local/arcanist-master/bin/arc" "$HOME/bin/arc"

pip3 -q install --user --upgrade pip neovim-remote cmake

CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
mkdir -p "$CONFIG_HOME"
for d in dots/*; do
  if [ -d "$d" ]; then
    ln -sf "$(readlink -f "$d")" -t "$CONFIG_HOME"
  else
    ln -sf "$(readlink -f "$d")" ~/."$(basename "$d")"
  fi
done

mkdir -p ~/bin
for b in bin/*; do
  ln -sf "$(readlink -f "$b")" ~/bin/"$(basename "$b")"
done
ln -sf "$(readlink -f up)" ~/bin/up

PLUG="${XDG_DATA_HOME:-$HOME/.local/share}/nvim/site/autoload/plug.vim"
if [ ! -f "$PLUG" ]; then
  curl -sSLfo "$PLUG" --create-dirs \
    'https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
fi
