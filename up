#!/bin/bash

set -e

cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"

DEB_ROCM_REPO=http://repo.radeon.com/rocm/apt/debian/
DEB_ROCM_CONF=/etc/apt/sources.list.d/rocm.list
export DEBIAN_FRONTEND=noninteractive

deb() {
  local CMD="$1"; shift
  local URL="$1"; shift
  if ! which "$CMD" >/dev/null; then
    local TMP
    TMP="$(mktemp)"
    curl -fLo "$TMP" "$URL"
    sudo dpkg -i "$TMP"
    rm "$TMP"
  fi
}

xargs sudo apt-get install -y <package-list

pip3 install --user neovim-remote MozPhab

mkdir -p ~/bin

[ -f ~/bin/nvim ] || \
  curl -fLo ~/bin/nvim https://github.com/neovim/neovim/releases/download/v0.4.3/nvim.appimage
chmod u+x ~/bin/nvim

deb fd https://github.com/sharkdp/fd/releases/download/v7.4.0/fd-musl_7.4.0_amd64.deb
deb rg https://github.com/BurntSushi/ripgrep/releases/download/11.0.2/ripgrep_11.0.2_amd64.deb
deb bat https://github.com/sharkdp/bat/releases/download/v0.12.1/bat_0.12.1_amd64.deb
deb delta https://github.com/dandavison/delta/releases/download/0.1.1/git-delta_0.1.1_amd64.deb

if ! which docker >/dev/null; then
  curl -fsSL get.docker.com | sudo sh
fi
sudo sh -c 'cat >/etc/docker/daemon.json' <<EOF
{
    "dns": ["10.234.250.9"],
    "insecure-registries": [
        "compute-artifactory.amd.com:5000",
        "compute-artifactory.amd.com:5001",
        "appperflab-1.amd.com:5000"
    ],
    "storage-driver": "overlay2"
}
EOF
sudo systemctl restart docker

for d in dots/*; do
  if [ -d "$d" ]; then
    ln -sf "$(readlink -f "$d")" \
      "${XDG_CONFIG_HOME:-$HOME/.config}/$(basename "$d")"
  else
    ln -sf "$(readlink -f "$d")" ~/."$(basename "$d")"
  fi
done

for b in bin/*; do
  ln -sf "$(readlink -f "$b")" ~/bin/"$(basename "$b")"
done

ln -sf "$(readlink -f up)" ~/bin/up

PLUG="${XDG_DATA_HOME:-$HOME/.local/share}/nvim/site/autoload/plug.vim"
if [ ! -f "$PLUG" ]; then
  curl -fLo "$PLUG" --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  nvim -es -c :PlugInstall -c :qa
fi

if ! dpkg -l | grep rocm -q; then
  wget -qO - "$DEB_ROCM_REPO/rocm.gpg.key" | sudo apt-key add -
  sudo sh -c "echo deb [arch=amd64] $DEB_ROCM_REPO xenial main > $DEB_ROCM_CONF"
  sudo apt-get update -y
  sudo apt-get install -y rocm-dkms
fi

sudo usermod -a -G video "$USER"
