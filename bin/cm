#!/bin/bash

usage() {
  printf 'cm - cmake wrapper for common configurations\n\n'
  printf 'usage: %s [-s] [-o] [-t targets] [-f cxx-flag]... [-g c-flag]... [-m] [-d] [-e] [-x] [-p path]... [-- [cmake-args...]] <path-to-source>\n' "$0"
  printf '  -s: enable ASan and UBSan for LLVM\n'
  printf '  -o: enable options for building OpenCL\n'
  printf '  -t: specify LLVM targets to build\n'
  printf '  -f: append to CXX flags\n'
  printf '  -g: append to C flags\n'
  printf '  -m: use GNU Makefiles instead of Ninja\n'
  printf '  -d: enable Debug build and limit link jobs to 2\n'
  printf '  -e: enable LLVM expensive checks\n'
  printf '  -x: enable Sphinx docs for LLVM\n'
  printf '  -p: append to CMAKE_PREFIX_PATH\n'
}

join() {
  local IFS="$1"; shift
  printf '%s' "$*"
}

compiler_is_clang() {
  local CC="$CC"
  [[ -n $CC ]] || CC='cc'
  local CXX="$CXX"
  [[ -n $CXX ]] || CXX='c++'
  # FIXME: this may be imprecise, but it seems to work
  eval "$CC --version" | grep -qi 'clang' &&
    eval "$CXX --version" | grep -qi 'clang'
}

C_FLAGS=()
CXX_FLAGS=()
PREFIX_PATHS=()

OPTS=('-GNinja'
      '-DCMAKE_BUILD_TYPE=Release'
      '-DCMAKE_INSTALL_PREFIX=dist'
      '-DLLVM_ENABLE_PROJECTS=llvm;clang;lld'
      '-DLLVM_ENABLE_ASSERTIONS=On'
      '-DCMAKE_EXPORT_COMPILE_COMMANDS=On')

if compiler_is_clang; then
  C_FLAGS+=('-fcolor-diagnostics')
  CXX_FLAGS+=('-fcolor-diagnostics')
  OPTS+=('-DLLVM_USE_LINKER=lld')
fi

OPTIND=1

while getopts ':sot:f:g:mdexp:' opt; do
  case "$opt" in
    h|\?)
      usage
      exit 0
      ;;
    s)
      if [[ -z $LIBCXX_ASAN_C_FLAGS || -z $LIBCXX_ASAN_CXX_FLAGS || -z $LIBCXX_ASAN_EXE_LINKER_FLAGS ]]; then
	printf 'error: LIBCXX_ASAN_C_FLAGS and LIBCXX_ASAN_CXX_FLAGS and LIBCXX_ASAN_EXE_LINKER_FLAGS must be set!\n'
	exit 1
      fi
      ASAN_FLAGS='-fsanitize=address,undefined -fno-sanitize=vptr,function -fno-sanitize-recover=all'
      C_FLAGS+=("$LIBCXX_ASAN_C_FLAGS $ASAN_FLAGS")
      CXX_FLAGS+=("$LIBCXX_ASAN_CXX_FLAGS $ASAN_FLAGS")
      OPTS+=('-DLLVM_USE_SANITIZER=Address;Undefined'
	     '-DCMAKE_SHARED_LINKER_FLAGS=-stdlib=libc++'
	     '-DCMAKE_MODULE_LINKER_FLAGS=-stdlib=libc++'
	     "-DCMAKE_EXE_LINKER_FLAGS=$LIBCXX_ASAN_EXE_LINKER_FLAGS -stdlib=libc++"
	     '-DLLVM_PARALLEL_LINK_JOBS=2')
      ;;
    o)
      OPTS+=('-DCLANG_ENABLE_STATIC_ANALYZER=On'
	     '-DLLVM_TARGETS_TO_BUILD=AMDGPU;X86' '-DLLVM_BUILD_TOOLS=On'
	     '-DLLVM_INCLUDE_TESTS=On')
      ;;
    t)
      OPTS+=("-DLLVM_TARGETS_TO_BUILD=$OPTARG")
      ;;
    f)
      CXX_FLAGS+=("$OPTARG")
      ;;
    g)
      C_FLAGS+=("$OPTARG")
      ;;
    m)
      OPTS+=('-GUnix Makefiles')
      ;;
    d)
      OPTS+=('-DCMAKE_BUILD_TYPE=Debug' '-DLLVM_PARALLEL_LINK_JOBS=2'
	     '-DLLVM_OPTIMIZED_TABLEGEN=On')
      ;;
    e)
      OPTS+=('-DLLVM_ENABLE_EXPENSIVE_CHECKS=On' '-DLLVM_ENABLE_WERROR=Off'
	     '-DLLVM_OPTIMIZED_TABLEGEN=On')
      ;;
    x)
      OPTS+=('-DLLVM_BUILD_DOCS=On' '-DLLVM_ENABLE_SPHINX=On')
      ;;
    p)
      PREFIX_PATHS+=("$OPTARG")
      ;;
  esac
done

# FIXME: C and CXX flags with spaces still aren't handled right
OPTS+=("-DCMAKE_C_FLAGS=$(join ' ' "${C_FLAGS[@]}")")
OPTS+=("-DCMAKE_CXX_FLAGS=$(join ' ' "${CXX_FLAGS[@]}")")
OPTS+=("-DCMAKE_PREFIX_PATH=$(join ';' "${PREFIX_PATHS[@]}")")

shift $((OPTIND-1))
[ "${1:-}" = '--' ] && shift

rm -rf CMakeCache.txt CMakeFiles
cmake "${OPTS[@]}" "$@"
