#!/bin/bash

#| Usage: cm [-C build-dir] [-#dehmsx] [-b llvm-project]...
#|   [-o compile-option]... [-p prefix-path]... [-t llvm-target]...
#|   [-- [cmake-args...]] <path-to-source>
#|
#| Wrapper for cmake(1) with saner defaults, some convenience options,
#| and support for LLVM quirks built-in. Options with a '...' suffix
#| can be repeated with cumulative effect.
#|
#|   -#    perform a dry run, only printing the generated CMake command line
#|   -C    change to dir before doing anything else (default: build)
#|         (path-to-source is interpreted before this takes effect)
#|   -b    append to LLVM_ENABLE_PROJECTS (if not set: llvm;clang;lld)
#|   -d    enable Debug build (llvm: also enable optimized TableGen)
#|   -e    enable LLVM expensive checks
#|   -h    print this help text and exit
#|   -m    use the Unix Makefiles generator (default: Ninja)
#|   -o    append to C_FLAGS and CXX_FLAGS
#|   -p    append to CMAKE_PREFIX_PATH
#|   -s    enable ASan and UBSan
#|   -t    append to LLVM_TARGETS_TO_BUILD (default: all)
#|   -x    enable LLVM_BUILD_DOCS

set -euo pipefail

usage() {
  sed -n 's/^#| \?\(.*\)$/\1/p' "$0"
}

usage_then_exit() {
  local -r STATUS="$1"; shift
  usage >&$(( STATUS ? 2 : 1 ))
  exit "$STATUS"
}

dief() {
  local -r STATUS="$1"; shift
  local -r FMT="$1"; shift
  printf "%s: error: $FMT" "$0" "$@" >&2
  exit "$STATUS"
}

join() {
  local -r IFS="$1"; shift
  printf '%s' "$*"
}

is_clang() {
  eval "${CC:-cc} --version" | grep -qi 'clang' \
    && eval "${CXX:-c++} --version" | grep -qi 'clang'
}

is_building_llvm() {
  local -r PATH_TO_SOURCE="$1"; shift
  [[ -e $PATH_TO_SOURCE && $(realpath -e "$PATH_TO_SOURCE") == *llvm-project* ]]
}

has_command() {
  local -r COMMAND="$1"; shift
  command -v "$COMMAND" >/dev/null
}

OPT_DRY_RUN=0
OPT_SANITIZE=0
OPT_DEBUG=0
OPT_MAKEFILES=0
OPT_COMPILE_OPTIONS=()
OPT_CMAKE_FLAGS=()
OPT_PREFIX_PATH=()
OPT_ENABLE_PROJECTS=()
OPT_TARGETS_TO_BUILD=()
OPT_CHANGE_DIR=''

while getopts '#C:b:dehmo:p:st:x' opt; do
  case "$opt" in
    '?') usage_then_exit 1 ;;
    '#') OPT_DRY_RUN=1 ;;
    C) OPT_CHANGE_DIR="$OPTARG" ;;
    b) OPT_ENABLE_PROJECTS+=("$OPTARG") ;;
    d) OPT_DEBUG=1 ;;
    e) OPT_CMAKE_FLAGS+=('-DLLVM_ENABLE_EXPENSIVE_CHECKS=On' '-DLLVM_ENABLE_WERROR=Off' '-DLLVM_OPTIMIZED_TABLEGEN=On') ;;
    h) usage_then_exit 0 ;;
    m) OPT_MAKEFILES=1 ;;
    o) OPT_COMPILE_OPTIONS+=("$OPTARG") ;;
    p) OPT_PREFIX_PATH+=("$OPTARG") ;;
    s) OPT_SANITIZE=1 ;;
    t) OPT_TARGETS_TO_BUILD+=("$OPTARG") ;;
    x) OPT_CMAKE_FLAGS+=('-DLLVM_BUILD_DOCS=On') ;;
  esac
done
readonly OPT_DRY_RUN OPT_COMPILE_OPTIONS OPT_CMAKE_FLAGS OPT_PREFIX_PATH \
  OPT_ENABLE_PROJECTS OPT_TARGETS_TO_BUILD OPT_CHANGE_DIR

shift $(( OPTIND - 1 ))
[[ ${1:-} == '--' ]] && shift

# All valid command lines have at least path-to-source, and this also makes the
# command with no arguments at all a pseudo-alias for `-h`.
(( $# )) || usage_then_exit 1

path_to_source="${*: -1}"

if [[ -n $OPT_CHANGE_DIR ]]; then
  [[ -d $OPT_CHANGE_DIR ]] || dief 1 '"%s" is not a directory.\n' "$OPT_CHANGE_DIR"
  # Avoid changing a relative path to an absolute one
  if [[ -d $path_to_source && $path_to_source != /* ]]; then
    path_to_source="$(realpath --relative-to="$OPT_CHANGE_DIR" "$path_to_source")"
    set -- "${@:1:(($#-1))}" "$path_to_source"
  fi
  cd "$OPT_CHANGE_DIR"
fi

# Set up some default options
opts=('-DCMAKE_INSTALL_PREFIX=dist'
      '-DCMAKE_EXPORT_COMPILE_COMMANDS=On')

if is_building_llvm "$path_to_source"; then
  opts+=('-DLLVM_ENABLE_ASSERTIONS=On')
  has_command sphinx-build && opts+=('-DLLVM_ENABLE_SPHINX=On')
  if has_command lld; then
    opts+=('-DLLVM_USE_LINKER=lld')
  elif has_command gold; then
    opts+=('-DLLVM_USE_LINKER=gold')
  fi
fi

if has_command ccache; then
  if is_building_llvm "$path_to_source"; then
    opts+=('-DLLVM_CCACHE_BUILD=On')
  else
    opts+=('-DCMAKE_C_COMPILER_LAUNCHER=ccache')
    opts+=('-DCMAKE_CXX_COMPILER_LAUNCHER=ccache')
  fi
fi

compile_options=()
is_clang && compile_options+=('-fcolor-diagnostics')

# And then process all of the user options
if (( OPT_SANITIZE )); then
  if is_building_llvm "$path_to_source"; then
    opts+=('-DLLVM_USE_SANITIZER=Address;Undefined' '-DLLVM_USE_SANITIZE_COVERAGE=Yes')
  else
    compile_options+=('-fsanitize=address,undefined')
  fi
fi

if (( OPT_DEBUG )); then
  opts+=('-DCMAKE_BUILD_TYPE=Debug')
  is_building_llvm "$path_to_source" && opts+=('-DLLVM_OPTIMIZED_TABLEGEN=On')
else
  opts+=('-DCMAKE_BUILD_TYPE=Release')
fi

if (( OPT_MAKEFILES )) || ! has_command ninja; then
  opts+=('-GUnix Makefiles')
else
  opts+=('-GNinja')
fi

for opt in "${OPT_CMAKE_FLAGS[@]}"; do
  opts+=("$opt")
done

for compile_option in "${OPT_COMPILE_OPTIONS[@]}"; do
  compile_options+=("$compile_option")
done
opts+=("-DCMAKE_C_FLAGS=$(printf '"%s" ' "${compile_options[@]}")")
opts+=("-DCMAKE_CXX_FLAGS=$(printf '"%s" ' "${compile_options[@]}")")

opts+=("-DCMAKE_PREFIX_PATH=$(join ';' "${OPT_PREFIX_PATH[@]}")")

if (( ${#OPT_ENABLE_PROJECTS[@]} )); then
  opts+=("-DLLVM_ENABLE_PROJECTS=$(join ';' "${OPT_ENABLE_PROJECTS[@]}")")
elif is_building_llvm "$path_to_source"; then
  opts+=("-DLLVM_ENABLE_PROJECTS=llvm;clang;lld")
fi

if (( ${#OPT_TARGETS_TO_BUILD[@]} )); then
  opts+=("-DLLVM_TARGETS_TO_BUILD=$(join ';' "${OPT_TARGETS_TO_BUILD[@]}")")
elif is_building_llvm "$path_to_source"; then
  opts+=("-DLLVM_TARGETS_TO_BUILD=all")
fi

printf "cmake "
printf "'%s' " "${opts[@]}" "$@"
printf "\n"

(( OPT_DRY_RUN )) && exit 0

rm -rf CMakeCache.txt CMakeFiles

cmake "${opts[@]}" "$@"
