#!/bin/bash

usage() {
  printf 'cm - cmake wrapper for common configurations\n\n'
  printf 'usage: %s [-#] [-s] [-o] [-f cxx-flag]... [-g c-flag]... [-m] [-d] [-e] [-x] [-p path]... [-b project]... [-t target]... [-- [cmake-args...]] <path-to-source>\n' "$0"
  printf '  -#: perform a dry run, only printing the CMake command line\n'
  printf '  -s: enable ASan and UBSan for LLVM\n'
  printf '  -o: enable options for building OpenCL\n'
  printf '  -f: append to CXX flags\n'
  printf '  -g: append to C flags\n'
  printf '  -m: use GNU Makefiles instead of Ninja\n'
  printf '  -d: enable Debug build and limit link jobs to 2\n'
  printf '  -e: enable LLVM expensive checks\n'
  printf '  -x: enable Sphinx docs for LLVM\n'
  printf '  -p: append to CMAKE_PREFIX_PATH (default: empty)\n'
  printf '  -b: append to LLVM_ENABLE_PROJECTS (default: llvm;clang;lld)\n'
  printf '  -t: append to LLVM_TARGETS_TO_BUILD targets to build (default: all)\n'
}

join() {
  local IFS="$1"; shift
  printf '%s' "$*"
}

is_clang() {
  local CC="$CC"
  [[ -n $CC ]] || CC='cc'
  local CXX="$CXX"
  [[ -n $CXX ]] || CXX='c++'
  # FIXME: this may be imprecise, but it seems to work
  eval "$CC --version" | grep -qi 'clang' &&
    eval "$CXX --version" | grep -qi 'clang'
}

is_building_llvm() {
  pwd | grep -q llvm-project
}

has_command() {
  command -v "$1" >/dev/null
}

C_FLAGS=()
CXX_FLAGS=()
PREFIX_PATHS=()
ENABLED_PROJECTS=()
TARGETS_TO_BUILD=()
DRY_RUN=0

OPTS=('-GNinja'
      '-DCMAKE_BUILD_TYPE=Release'
      '-DCMAKE_INSTALL_PREFIX=dist'
      '-DCMAKE_EXPORT_COMPILE_COMMANDS=On')

if is_building_llvm; then
  OPTS+=('-DLLVM_ENABLE_ASSERTIONS=On' '-DLLVM_ENABLE_SPHINX=On')
  if has_command ccache; then
    OPTS+=('-DLLVM_CCACHE_BUILD=On'
           '-DLLVM_CCACHE_MAXSIZE=256G')
  fi
fi

if is_clang; then
  C_FLAGS+=('-fcolor-diagnostics')
  CXX_FLAGS+=('-fcolor-diagnostics')
  if is_building_llvm; then
    OPTS+=('-DLLVM_USE_LINKER=lld')
  fi
fi

OPTIND=1

while getopts ':#sof:g:mdexp:b:t:' opt; do
  case "$opt" in
    h|\?)
      usage
      exit 0
      ;;
    '#')
      DRY_RUN=1
      ;;
    s)
      if is_building_llvm; then
        OPTS+=('-DLLVM_USE_SANITIZER=Address;Undefined'
               '-DLLVM_USE_SANITIZE_COVERAGE=Yes'
               '-DLLVM_PARALLEL_LINK_JOBS=2')
      else
        C_FLAGS+=('-fsanitize=address,undefined')
        CXX_FLAGS+=('-fsanitize=address,undefined')
      fi
      ;;
    o)
      OPTS+=('-DCLANG_ENABLE_STATIC_ANALYZER=On'
             '-DLLVM_TARGETS_TO_BUILD=AMDGPU;X86' '-DLLVM_BUILD_TOOLS=On'
             '-DLLVM_INCLUDE_TESTS=On')
      ;;
    f)
      CXX_FLAGS+=("$OPTARG")
      ;;
    g)
      C_FLAGS+=("$OPTARG")
      ;;
    m)
      OPTS+=('-GUnix Makefiles')
      ;;
    d)
      OPTS+=('-DCMAKE_BUILD_TYPE=Debug')
      if is_building_llvm; then
        OPTS+=('-DLLVM_PARALLEL_LINK_JOBS=2' '-DLLVM_OPTIMIZED_TABLEGEN=On')
      fi
      ;;
    e)
      OPTS+=('-DLLVM_ENABLE_EXPENSIVE_CHECKS=On' '-DLLVM_ENABLE_WERROR=Off'
             '-DLLVM_OPTIMIZED_TABLEGEN=On')
      ;;
    x)
      OPTS+=('-DLLVM_BUILD_DOCS=On' '-DLLVM_ENABLE_SPHINX=On')
      ;;
    p)
      PREFIX_PATHS+=("$OPTARG")
      ;;
    b)
      ENABLED_PROJECTS+=("$OPTARG")
      ;;
    t)
      TARGETS_TO_BUILD+=("$OPTARG")
      ;;
  esac
done

# FIXME: C and CXX flags with spaces still aren't handled right
OPTS+=("-DCMAKE_C_FLAGS=$(join ' ' "${C_FLAGS[@]}")")
OPTS+=("-DCMAKE_CXX_FLAGS=$(join ' ' "${CXX_FLAGS[@]}")")
OPTS+=("-DCMAKE_PREFIX_PATH=$(join ';' "${PREFIX_PATHS[@]}")")
if [ ${#ENABLED_PROJECTS[@]} -ne 0 ]; then
  OPTS+=("-DLLVM_ENABLE_PROJECTS=$(join ';' "${ENABLED_PROJECTS[@]}")")
elif is_building_llvm; then
  OPTS+=("-DLLVM_ENABLE_PROJECTS=llvm;clang;lld")
fi
if [ ${#TARGETS_TO_BUILD[@]} -ne 0 ]; then
  OPTS+=("-DLLVM_TARGETS_TO_BUILD=$(join ';' "${TARGETS_TO_BUILD[@]}")")
elif is_building_llvm; then
  OPTS+=("-DLLVM_TARGETS_TO_BUILD=all")
fi

shift $((OPTIND-1))
[ "${1:-}" = '--' ] && shift

rm -rf CMakeCache.txt CMakeFiles
printf "cmake "
printf "'%s' " "${OPTS[@]}" "$@"
printf "\n"
[ "$DRY_RUN" -eq 1 ] || cmake "${OPTS[@]}" "$@"
