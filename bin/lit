#!/bin/bash

#| Usage: lit [-C build-dir] [-bpv] [args...]
#|
#| Wrapper which runs the llvm-lit contained in the given LLVM build-dir, and
#| automates tracking which tests have failed across runs. By default, the
#| trailing args are interpreted as test-cases to pass to llvm-lit. If no
#| test-cases are provided, the default behavior is to run all tests which failed
#| in the last run within build-dir. If no such tests exists (i.e. all tests
#| passed), the script exits successfully without producing any output.
#|
#| If the -b flag is present, it instead invokes the CMake build tool in the
#| LLVM build-dir, and the trailing args are forwarded to it. This is useful
#| to build the default CMake target without running tests (i.e. `lit -b`) or to
#| run a specific test-suite to seed the "failing tests" for subsequent runs
#| (i.e. `lit -b check-llvm`).
#|
#| Note that this wrapper appends to LIT_OPTS internally to produce a
#| "resultdb" json file called lit.json in build-dir.
#|
#| A typical use-case might then be:
#|
#| $ lit -b check
#| FAIL: LLVM :: ...
#| ...
#| $ lit -v # re-run failures from check-all, seeing the RUN lines and all output
#| $ sed -i 's/tyop/typo/' $(lit -p) # fix a typo in all failing tests at once
#| $ lit -b && lit # re-build and re-run the failing tests
#| $ lit # this shouldn't print anything, and should return success
#|
#|   -C    the LLVM build directory to run tests in (default: build).
#|   -b    instead of running llvm-lit, invoke the CMake build tool in the LLVM
#|         build directory. Forward remaining arguments to the build tool.
#|   -p    instead of actually running llvm-lit, just print out the test cases
#|         that would be run.
#|   -v    be as verbose as possible, asking FileCheck to dump its input and
#|         asking lit to forward that to stdout.

set -euo pipefail
shopt -s lastpipe

usage() {
  sed -n 's/^#| \?\(.*\)$/\1/p' "$0"
}

usage_then_exit() {
  local -r STATUS="$1"; shift
  usage >&$(( STATUS ? 2 : 1 ))
  exit "$STATUS"
}

OPT_CHANGE_DIR=build
OPT_BUILD_ONLY=0
OPT_PRINT_ONLY=0
OPT_VERBOSE=0

while getopts 'C:bpv' opt; do
  case "$opt" in
    '?') usage_then_exit 1 ;;
    C) OPT_CHANGE_DIR="$OPTARG" ;;
    b) OPT_BUILD_ONLY=1 ;;
    p) OPT_PRINT_ONLY=1 ;;
    v) OPT_VERBOSE=1 ;;
  esac
done
readonly OPT_CHANGE_DIR OPT_BUILD_ONLY OPT_PRINT_ONLY OPT_VERBOSE

shift $(( OPTIND - 1 ))
[[ ${1:-} == '--' ]] && shift

# FIXME: fails if PWD or OPT_CHANGE_DIR embed '
export LIT_OPTS+="--resultdb-output '$PWD/$OPT_CHANGE_DIR/lit.json'"

if (($OPT_BUILD_ONLY)); then
  cmake --build "$OPT_CHANGE_DIR" -- "$@"
  exit $?
fi

RAW_ARGV=()
if (($#)); then
  RAW_ARGV=("$@")
else
  # FIXME: Is there a more reliable way to always translate these test suites?
  # FIXME: Is there a way to reasonably select specific failing unittests?
  jq -r '.tests[]|select(.expected|not).testId' "$OPT_CHANGE_DIR"/lit.json \
    | sed \
      -e 's#LLVM :: #llvm/test/#' \
      -e 's#LLVM-Unit :: .*#llvm/test/Unit#' \
      -e 's#Clang :: #clang/test/#' \
      -e 's#Clang-Unit :: .*#clang/test/Unit#' \
      -e 's#Flang :: #flang/test/#' \
      -e 's#flang-OldUnit :: .*#flang/test/NonGtestUnit#' \
      -e 's#flang-Unit :: .*#flang/test/Unit#' \
      -e 's#lld :: #lld/test/#' \
      -e 's#lldb :: #lldb/test/#' \
      -e 's#lldb-shell :: .*#lldb/test/Shell#' \
      -e 's#lldb-unit :: .*#lldb/test/Unit#' \
      -e 's#lldb-api :: .*#lldb/test/API#' \
      -e 's#MLIR :: #mlir/test/#' \
      -e 's#MLIR-Unit .*:: #mlir/test/Unit#' \
      -e 's#libomptarget :: [^:]* :: #openmp/libomptarget/test/#' \
      -e 's#ompt-test :: #openmp/libompd/test/#' \
      -e 's#libomp :: #openmp/runtime/test/#' \
      -e 's#OMPT multiplex :: #openmp/tools/multiplex/tests/#' \
      -e 's#libarcher :: #openmp/tools/archer/tests/#' \
      -e 's#Polly :: #polly/test/#' \
      -e 's#Polly-Unit :: .*#polly/test/Unit#' \
      -e 's#Polly - isl unit tests :: .*#polly/test/UnitIsl#' \
    | sort -u \
    | readarray -t RAW_ARGV
  ((${#RAW_ARGV[@]})) || exit 0
fi

ARGV=()
for arg in "${RAW_ARGV[@]}"; do
  ARGV+=("$(realpath -e "$arg")")
done

if (($OPT_PRINT_ONLY)); then
  printf '%s\n' "${ARGV[@]}"
  exit 0
fi

cd "$OPT_CHANGE_DIR"

if (($OPT_VERBOSE)); then
  FILECHECK_OPTS='--dump-input always' bin/llvm-lit -a "${ARGV[@]}"
else
  bin/llvm-lit "${ARGV[@]}"
fi
